<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fmail Chat</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f1f3f4;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
header {
  background: #1a73e8;
  color: white;
  padding: 15px;
  font-size: 1.4rem;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
}
#chat-container {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}
.message {
  background: white;
  padding: 10px 14px;
  border-radius: 12px;
  margin-bottom: 10px;
  max-width: 70%;
}
.message.user {
  background: #dcf8c6;
  margin-left: auto;
}
#friends {
  display: flex;
  gap: 5px;
  padding: 10px;
  background: white;
  border-top: 1px solid #ddd;
}
.friend-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  background: #1a73e8;
  color: white;
  cursor: pointer;
}
.friend-btn.active {
  background: #174ea6;
}
#input-area {
  display: flex;
  padding: 10px;
  background: white;
  border-top: 1px solid #ddd;
}
#message {
  flex: 1;
  padding: 10px;
  font-size: 1rem;
}
button {
  padding: 10px 15px;
  border: none;
  background: #1a73e8;
  color: white;
  font-weight: bold;
  cursor: pointer;
}
#videos {
  display: none;
  background: black;
  padding: 10px;
  gap: 10px;
}
video {
  width: 48%;
  border-radius: 8px;
}
</style>
</head>

<body>

<header>
  Fmail
  <div>
    <button onclick="startCall()">üìû Call</button>
    <button onclick="endCall()">‚ùå End</button>
    <button onclick="addFriend()">‚ûï Friend</button>
  </div>
</header>

<div id="videos">
  <video id="myVideo" autoplay muted></video>
  <video id="friendVideo" autoplay></video>
</div>

<div id="chat-container"></div>
<div id="friends"></div>

<div id="input-area">
  <input id="message" placeholder="Type a message..." />
  <button onclick="sendMessage()">Send</button>
</div>

<script type="module">
import { Peer } from "https://esm.sh/peerjs@1.5.5?bundle-deps";

let username = prompt("Pick your username") || "User";
const peer = new Peer(username);

let friends = [];
let currentFriend = null;
let conn = null;
let call = null;
let localStream = null;

/* ---------- FRIENDS ---------- */
function isFriend(name) {
  return friends.some(f => f === name);
}

function renderFriends() {
  const div = document.getElementById("friends");
  div.innerHTML = "";
  friends.forEach(name => {
    const btn = document.createElement("button");
    btn.className = "friend-btn" + (name === currentFriend ? " active" : "");
    btn.textContent = name;
    btn.onclick = () => selectFriend(name);
    div.appendChild(btn);
  });
}

function selectFriend(name) {
  currentFriend = name;
  renderFriends();
  addMessage("System", `Selected ${name}`, false);
}

window.addFriend = () => {
  const name = prompt("Friend username (peer ID)");
  if (!name || isFriend(name)) return;
  friends.push(name);
  renderFriends();
};

/* ---------- MEDIA ---------- */
async function startMedia() {
  if (!localStream) {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById("myVideo").srcObject = localStream;
  }
}

/* ---------- PEER EVENTS ---------- */
peer.on("connection", c => {
  if (!isFriend(c.peer)) {
    c.close();
    return;
  }
  conn = c;
  currentFriend = c.peer;
  renderFriends();

  c.on("data", d => {
    addMessage(d.user, d.text, false);
  });
});

peer.on("call", async incoming => {
  if (!isFriend(incoming.peer)) {
    incoming.close();
    return;
  }

  currentFriend = incoming.peer;
  renderFriends();

  await startMedia();
  incoming.answer(localStream);
  document.getElementById("videos").style.display = "flex";

  incoming.on("stream", s => {
    document.getElementById("friendVideo").srcObject = s;
  });
});

/* ---------- CALL ---------- */
window.startCall = async () => {
  if (!currentFriend) {
    alert("Select a friend first");
    return;
  }

  await startMedia();
  call = peer.call(currentFriend, localStream);

  call.on("stream", s => {
    document.getElementById("friendVideo").srcObject = s;
  });

  document.getElementById("videos").style.display = "flex";
};

window.endCall = () => {
  if (call) call.close();
  call = null;

  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }

  document.getElementById("videos").style.display = "none";
};

/* ---------- CHAT ---------- */
window.sendMessage = () => {
  const input = document.getElementById("message");
  const text = input.value.trim();
  if (!text) return;

  if (!currentFriend || !isFriend(currentFriend)) {
    alert("Select a friend first");
    return;
  }

  // üîë auto-connect data channel if needed
  if (!conn || conn.peer !== currentFriend || !conn.open) {
    conn = peer.connect(currentFriend);
    conn.on("data", d => {
      addMessage(d.user, d.text, false);
    });
  }

  conn.send({ user: username, text });
  addMessage(username, text, true);
  input.value = "";
};

function addMessage(user, text, mine) {
  const div = document.createElement("div");
  div.className = "message" + (mine ? " user" : "");
  div.innerHTML = `<b>${user}:</b> ${text}`;
  document.getElementById("chat-container").appendChild(div);
  document.getElementById("chat-container").scrollTop =
    document.getElementById("chat-container").scrollHeight;
}

/* ---------- ENTER ---------- */
document.getElementById("message").addEventListener("keydown", e => {
  if (e.key === "Enter") sendMessage();
});
</script>

</body>
</html>
