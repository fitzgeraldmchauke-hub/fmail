<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fmail Chat - Convex + PeerJS</title>
<style>
body { font-family: Arial,sans-serif; margin:0; background:#f1f3f4; display:flex; flex-direction:column; height:100vh; }
header { background:#1a73e8; color:white; padding:20px; font-size:1.5rem; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
#chat-container { flex:1; display:flex; flex-direction:column; padding:20px; overflow-y:auto; gap:10px; }
.message { background:white; padding:10px 15px; border-radius:15px; max-width:85%; word-wrap:break-word; overflow-wrap:break-word; white-space:pre-wrap; line-height:1.4; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
.message.user { align-self:flex-end; background:#dcf8c6; }
#input-area { display:flex; padding:10px 20px; background:#fff; border-top:1px solid #ddd; }
#message { flex:1; padding:12px; border-radius:5px; border:1px solid #ccc; outline:none; font-size:1rem; line-height:1.4; margin-right:10px; }
button { padding:10px 20px; border:none; border-radius:5px; background:#1a73e8; color:white; font-weight:bold; cursor:pointer; }
#videos { display:none; background:black; padding:10px; gap:10px; justify-content:center; }
video { width:45%; border-radius:10px; }
#friends { display:flex; flex-wrap:wrap; gap:5px; padding:10px 20px; background:#fff; border-top:1px solid #ddd; }
.friend-btn { padding:5px 10px; background:#1a73e8; color:white; border:none; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<header>
  Fmail Chat
  <div>
    <button onclick="startCall()">üìû Call</button>
    <button onclick="endCall()">‚ùå End Call</button>
    <button onclick="addFriend()">‚ûï Friend</button>
  </div>
</header>

<div id="videos">
  <video id="myVideo" autoplay muted></video>
  <video id="friendVideo" autoplay></video>
</div>

<div id="chat-container"></div>
<div id="friends"></div>

<div id="input-area">
  <input id="message" placeholder="Type a message..." />
  <button onclick="sendMessage()">Send</button>
</div>

<script type="module">
import { Peer } from "https://esm.sh/peerjs@1.5.5?bundle-deps";
import { ConvexClient } from "https://esm.sh/convex/browser";

// ------------------- Convex -------------------
const convex = new ConvexClient("https://brainy-peacock-656.convex.cloud"); // replace with your URL
let username = prompt("Pick your username:") || "User";
let friends = [];
let currentFriend = null;

// Load friends from Convex
async function loadFriends() {
  const result = await convex.query("friends/listFriends", { user: username });
  friends = result.map(f => f.friend);
  renderFriends();
}

function renderFriends() {
  const container = document.getElementById("friends");
  container.innerHTML = "";
  friends.forEach(name => {
    const btn = document.createElement("button");
    btn.className = "friend-btn";
    btn.textContent = name;
    btn.onclick = () => currentFriend = name;
    container.appendChild(btn);
  });
}

// Add friend via Convex
window.addFriend = async () => {
  const name = prompt("Enter friend's username:");
  if (!name || friends.includes(name)) return;
  await convex.mutation("friends/addFriend", { user: username, friend: name });
  friends.push(name);
  renderFriends();
};

// ------------------- PeerJS -------------------
const peer = new Peer(username);
let conn = null;
let call = null;
let localStream = null;

function isFriend(name) { return friends.includes(name); }

async function startMedia() {
  if (!localStream) {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById("myVideo").srcObject = localStream;
  }
}

function showVideos(show) {
  document.getElementById("videos").style.display = show ? "flex" : "none";
}

// PeerJS incoming connection
peer.on("connection", c => {
  if (!isFriend(c.peer)) return c.close();
  conn = c;
  conn.on("data", d => addMessage(d.user, d.text, false));
});

// PeerJS incoming call
peer.on("call", async incoming => {
  if (!isFriend(incoming.peer)) return incoming.close();
  currentFriend = incoming.peer;
  await startMedia();
  incoming.answer(localStream);
  showVideos(true);
  incoming.on("stream", s => document.getElementById("friendVideo").srcObject = s);
});

// Start a call
window.startCall = async () => {
  if (!currentFriend) return;
  await startMedia();
  call = peer.call(currentFriend, localStream);
  call.on("stream", s => document.getElementById("friendVideo").srcObject = s);
  showVideos(true);
};

// End call
window.endCall = () => {
  if (call) call.close();
  call = null;
  if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
  showVideos(false);
};

// Send chat message
window.sendMessage = () => {
  const input = document.getElementById("message");
  const text = input.value.trim();
  if (!text || !currentFriend) return;

  if (!conn || conn.peer !== currentFriend || !conn.open) {
    conn = peer.connect(currentFriend);
    conn.on("data", d => addMessage(d.user, d.text, false));
  }

  conn.send({ user: username, text });
  addMessage(username, text, true);
  input.value = "";
};

// Add message to chat
function addMessage(user, text, mine) {
  const div = document.createElement("div");
  div.className = "message" + (mine ? " user" : "");
  div.innerHTML = `<b>${user}:</b> ${text}`;
  const container = document.getElementById("chat-container");
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

document.getElementById("message").addEventListener("keydown", e => {
  if (e.key === "Enter") sendMessage();
});

loadFriends();
</script>

</body>
</html>
